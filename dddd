-- ✅ โหลด config จาก GitHub ก่อนอื่น
pcall(function()
    loadstring(game:HttpGet("https://raw.githubusercontent.com/SDsfwqq/Auto-Mob/main/config.lua"))()
end)

if getgenv then
    if getgenv().__autofarm_loaded then return else getgenv().__autofarm_loaded = true end
end

local Players = game:GetService("Players")
local Player = Players.LocalPlayer
local RunService = game:GetService("RunService")
local VirtualInputManager = game:GetService("VirtualInputManager")
local ReplicatedStorage = game:GetService("ReplicatedStorage")

-- ✅ ใช้ config จาก GitHub หรือใช้ค่า default
local config = getgenv().AutoFarmConfig or {}

local ATTACKS_PER_TARGET = config.ATTACKS_PER_TARGET or 10
local TELEPORT_DISTANCE_THRESHOLD = config.TELEPORT_DISTANCE_THRESHOLD or 12
local TARGET_RECHECK_DELAY = config.TARGET_RECHECK_DELAY or 1.25
local ATTACK_INTERVAL = config.ATTACK_INTERVAL or 0.15
local priorityMobs = config.priorityMobs or { "Walrus", "Ankylosaurus", "Argentavis", "Stegosaurus" }
local mobNames = config.mobNames or { "Dimorph", "Ptero", "Stego" }

-- ✅ ใช้ targetResources จาก config หรือค่า default
local targetResources = config.targetResources or {
    Bacon = 100,
    Meat = 100,
    Ashes = 100,
    Fossil = 100,
}

local lastTarget, lastAttackTime, lastTargetSwitchTime = nil, 0, 0
local autoEnabled, teleported = false, false
local farmLoop = nil

local function getMountedDragon()
    local char = Player.Character or Player.CharacterAdded:Wait()
    local dragons = char:FindFirstChild("Dragons")
    if not dragons then return end
    for _, d in ipairs(dragons:GetChildren()) do
        local seat = d:FindFirstChildWhichIsA("VehicleSeat") or d:FindFirstChild("Seat")
        if seat and seat.Occupant == char:FindFirstChildOfClass("Humanoid") then return d end
    end
end

local function teleportTo(target)
    local pos = target:IsA("BasePart") and target.Position
        or (target.PrimaryPart and target.PrimaryPart.Position)
        or (target:FindFirstChild("HumanoidRootPart") and target.HumanoidRootPart.Position)
        or (target:FindFirstChildWhichIsA("BasePart") and target:FindFirstChildWhichIsA("BasePart").Position)

    if Player.Character and Player.Character.PrimaryPart and typeof(pos) == "Vector3" then
        local dist = (Player.Character.PrimaryPart.Position - pos).Magnitude
        if dist > TELEPORT_DISTANCE_THRESHOLD then
            local angle = math.rad(math.random(0, 360))
            local offset = Vector3.new(math.cos(angle), 0, math.sin(angle)) * 15
            local safePos = pos + offset + Vector3.new(0, 3, 0)
            pcall(function()
                Player.Character:SetPrimaryPartCFrame(CFrame.new(safePos))
            end)
        end
    end
end

local function hyperAttack(target, dragon)
    local remote = dragon:FindFirstChild("Remotes") and dragon.Remotes:FindFirstChild("PlaySoundRemote")
    if not remote then return end
    for i = 1, ATTACKS_PER_TARGET do
        if not target or not target:FindFirstChild("Health") or target.Health.Value <= 0 then break end
        remote:FireServer("Breath", "Mobs", target)
        task.wait(ATTACK_INTERVAL)
    end
end

local function performBiteAndBreath()
    local dragon = getMountedDragon()
    if not dragon then return end
    local breath = dragon:FindFirstChild("Remotes") and dragon.Remotes:FindFirstChild("BreathFireRemote")
    if breath then breath:FireServer(true) end
    VirtualInputManager:SendKeyEvent(true, Enum.KeyCode.F, false, game)
    task.wait(0.05)
    VirtualInputManager:SendKeyEvent(false, Enum.KeyCode.F, false, game)
end

local function findTarget()
    local global = workspace:FindFirstChild("Interactions")
    global = global and global:FindFirstChild("Nodes")
    global = global and global:FindFirstChild("Mobs")
    global = global and global:FindFirstChild("ActiveMobs")
    global = global and global:FindFirstChild("Global")
    if global then
        for _, name in ipairs(priorityMobs) do
            local mob = global:FindFirstChild(name)
            if mob and mob:FindFirstChild("Health") and mob.Health.Value > 0 then return mob end
        end
    end
    local folder = workspace:FindFirstChild("MobFolder")
    if folder then
        for _, wrapper in ipairs(folder:GetChildren()) do
            for _, name in ipairs(mobNames) do
                local mob = wrapper:FindFirstChild(name)
                if mob and mob:FindFirstChild("Health") and mob.Health.Value > 0 then return mob end
            end
        end
    end
end

local gui = Instance.new("ScreenGui", game.CoreGui)
gui.Name = "FarmStatsUI"

local function createBox(name, iconText, position)
    local frame = Instance.new("Frame", gui)
    frame.Size = UDim2.new(0, 140, 0, 60)
    frame.Position = position
    frame.BackgroundColor3 = Color3.fromRGB(40, 40, 80)

    local label = Instance.new("TextLabel", frame)
    label.Size = UDim2.new(1, 0, 0.5, 0)
    label.Text = iconText .. "  " .. name
    label.TextColor3 = Color3.new(1,1,0.7)
    label.BackgroundTransparency = 1
    label.Font = Enum.Font.GothamBold
    label.TextSize = 18

    local valueLabel = Instance.new("TextLabel", frame)
    valueLabel.Name = "ValueLabel"
    valueLabel.Position = UDim2.new(0, 0, 0.5, 0)
    valueLabel.Size = UDim2.new(1, 0, 0.5, 0)
    valueLabel.Text = "..."
    valueLabel.Font = Enum.Font.Gotham
    valueLabel.TextSize = 20
    valueLabel.TextColor3 = Color3.new(1,1,1)
    valueLabel.BackgroundTransparency = 1
    valueLabel.Parent = frame

    return frame
end

-- ✅ ใช้ teleportWorlds จาก config หรือค่า default
local teleportWorlds = config.teleportWorlds or {
    ["Origins"] = 3475397644,
    ["Grassland"] = 3475419198,
    ["Jungle"] = 3475422608,
    ["Volcano"] = 3487210751,
    ["Tundra"] = 3623549100,
    ["Ocean"] = 3737848045,
    ["Desert"] = 3752680052,
    ["Fantasy"] = 4174118306,
    ["Wasteland"] = 4728805070,
    ["Prehistoric"] = 4869039553,
}

local dropdownFrame = Instance.new("Frame", gui)
dropdownFrame.Size = UDim2.new(0, 180, 0, 40)
dropdownFrame.Position = UDim2.new(0, 320, 0, 170)
dropdownFrame.BackgroundColor3 = Color3.fromRGB(50, 50, 90)

local dropdownButton = Instance.new("TextButton", dropdownFrame)
dropdownButton.Size = UDim2.new(1, 0, 1, 0)
dropdownButton.Text = "🌐 Teleport to World"
dropdownButton.Font = Enum.Font.GothamBold
dropdownButton.TextColor3 = Color3.new(1,1,1)
dropdownButton.TextSize = 18
dropdownButton.BackgroundColor3 = Color3.fromRGB(70, 70, 130)

local menuFrame = Instance.new("Frame", gui)
menuFrame.Position = dropdownFrame.Position + UDim2.new(0, 0, 0, 40)
menuFrame.Size = UDim2.new(0, 180, 0, 150)
menuFrame.BackgroundColor3 = Color3.fromRGB(60, 60, 100)
menuFrame.Visible = false
menuFrame.ClipsDescendants = true

local layout = Instance.new("UIListLayout", menuFrame)
layout.FillDirection = Enum.FillDirection.Vertical

for worldName, placeId in pairs(teleportWorlds) do
    local btn = Instance.new("TextButton")
    btn.Size = UDim2.new(1, 0, 0, 30)
    btn.Text = worldName
    btn.Font = Enum.Font.Gotham
    btn.TextSize = 16
    btn.TextColor3 = Color3.new(1,1,1)
    btn.BackgroundColor3 = Color3.fromRGB(90, 90, 140)
    btn.Parent = menuFrame

    btn.MouseButton1Click:Connect(function()
        menuFrame.Visible = false
        ReplicatedStorage.Remotes.WorldTeleportRemote:InvokeServer(placeId, {})
    end)
end

dropdownButton.MouseButton1Click:Connect(function()
    menuFrame.Visible = not menuFrame.Visible
end)

local resourceBoxes = {}
local inputYOffset, boxX = 230, 20

for name, goal in pairs(targetResources) do
    local icon = name == "Bacon" and "🥓" or name == "Meat" and "🍖" or name == "Ashes" and "🧱" or name == "Fossil" and "🦴" or "📦"
    local box = createBox(name, icon, UDim2.new(0, boxX, 0, 100))
    resourceBoxes[name] = box

    local input = Instance.new("TextBox", gui)
    input.Size = UDim2.new(0, 100, 0, 30)
    input.Position = UDim2.new(0, boxX, 0, inputYOffset)
    input.Text = tostring(goal)
    input.PlaceholderText = name .. " Goal"
    input.BackgroundColor3 = Color3.fromRGB(90, 90, 130)
    input.TextColor3 = Color3.new(1,1,1)
    input.FocusLost:Connect(function()
        local v = tonumber(input.Text)
        if v then targetResources[name] = v end
    end)

    boxX += 110
end

local toggleButton = Instance.new("TextButton", gui)
toggleButton.Size = UDim2.new(0, 120, 0, 50)
toggleButton.Position = UDim2.new(0, 20, 0, 170)
toggleButton.Text = "STOP"
toggleButton.BackgroundColor3 = Color3.fromRGB(255, 60, 60)
toggleButton.TextColor3 = Color3.new(1, 1, 1)
toggleButton.Font = Enum.Font.GothamBold
toggleButton.TextSize = 22

local function startFarm()
    if farmLoop then return end
    farmLoop = RunService.Heartbeat:Connect(function()
        if not autoEnabled then return end
        if game.PlaceId ~= 4869039553 then return end
        local now = tick()
        local dragon = getMountedDragon()
        if not dragon then return end

        if now - lastTargetSwitchTime > TARGET_RECHECK_DELAY or not lastTarget or (lastTarget:FindFirstChild("Health") and lastTarget.Health.Value <= 0) then
            lastTarget = findTarget()
            lastTargetSwitchTime = now
        end

        if lastTarget then
            teleportTo(lastTarget)
            if now - lastAttackTime > ATTACK_INTERVAL * ATTACKS_PER_TARGET then
                hyperAttack(lastTarget, dragon)
                performBiteAndBreath()
                lastAttackTime = now
            end
        end
    end)
end

toggleButton.MouseButton1Click:Connect(function()
    if autoEnabled then
        if farmLoop then farmLoop:Disconnect() farmLoop = nil end
        autoEnabled = false
        lastTarget = nil
        toggleButton.Text = "START"
        toggleButton.BackgroundColor3 = Color3.fromRGB(60, 200, 60)
    else
        autoEnabled = true
        toggleButton.Text = "STOP"
        toggleButton.BackgroundColor3 = Color3.fromRGB(255, 60, 60)
        startFarm()
    end
end)

autoEnabled = true
startFarm()

task.spawn(function()
    while true do
        local dragonsFolder = workspace:FindFirstChild("Characters") and workspace.Characters:FindFirstChild(Player.Name):FindFirstChild("Dragons")
        if dragonsFolder then
            for i = 1, 100 do
                local dragon = dragonsFolder:FindFirstChild(tostring(i))
                local dead = dragon and dragon:FindFirstChild("Data") and dragon.Data:FindFirstChild("Dead")
                if dead and dead.Value then dead.Value = false end
            end
        end
        task.wait(1)
    end
end)

task.spawn(function()
    while true do
        task.wait(60)
        VirtualInputManager:SendMouseMoveEvent(1, 0, 0, false)
        VirtualInputManager:SendMouseMoveEvent(-1, 0, 0, false)
    end
end)

task.spawn(function()
    while true do
        local data = Player:FindFirstChild("Data")
        local res = data and data:FindFirstChild("Resources")
        local cur = data and data:FindFirstChild("Currency")

        local reached = true
        for name, goal in pairs(targetResources) do
            local val = (res and res:FindFirstChild(name) and res[name].Value) or 0
            resourceBoxes[name].ValueLabel.Text = tostring(val)
            if val < goal then reached = false end
        end

        if reached and not teleported and game.PlaceId == 4869039553 then
            teleported = true
            ReplicatedStorage.Remotes.WorldTeleportRemote:InvokeServer(3475397644, {})
        end

        if game.PlaceId == 3475397644 then
            for name, _ in pairs(targetResources) do
                local r = res and res:FindFirstChild(name)
                if r and r.Value > 0 then
                    ReplicatedStorage.Remotes.SellItemRemote:FireServer({ ItemName = name, Amount = r.Value })
                end
            end
            task.wait(1.5)
            ReplicatedStorage.Remotes.WorldTeleportRemote:InvokeServer(4869039553, {})
            teleported = false
        end

        task.wait(0.5)
    end
end)

-- ✅ ใช้ performance config จาก GitHub
if config.enablePerformanceOptimization ~= false then
    task.spawn(function()
        local ws = workspace
        for _, obj in ipairs(ws:GetDescendants()) do
            if obj:IsA("BasePart") then
                obj.Material = Enum.Material.SmoothPlastic
                obj.Reflectance = 0
                obj.CastShadow = false
            end
            if obj:IsA("ParticleEmitter") or obj:IsA("Trail") or obj:IsA("Beam") then
                obj.Enabled = false
            elseif obj:IsA("Decal") or obj:IsA("Texture") then
                obj.Transparency = 1
            elseif obj:IsA("Light") then
                obj.Enabled = false
            end
        end

        for _, l in ipairs(game.Lighting:GetChildren()) do
            if not l:IsA("Sky") then l:Destroy() end
        end
        game.Lighting.FogEnd = 9e9
        game.Lighting.GlobalShadows = false
        game.Lighting.Brightness = 0
        game.Lighting.ClockTime = 14

        settings().Rendering.QualityLevel = Enum.QualityLevel.Level01
        settings().Rendering.MeshPartDetailLevel = Enum.MeshPartDetailLevel.Level02

        local terrain = ws:FindFirstChildOfClass("Terrain")
        if terrain then
            terrain.WaterWaveSize = 0
            terrain.WaterTransparency = 1
            terrain.WaterReflectance = 0
            terrain.WaterWaveSpeed = 0
        end

        print("เปิดใช้งาน Performance Optimization")
    end)
end
